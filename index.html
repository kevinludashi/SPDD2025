<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>商品订单综合管理系统 v10.2.250910.02</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            font-size: 14px;
            line-height: 1.4;
            color: #333;
            padding-bottom: 60px; /* 为底部导航留出空间 */
        }
        .container {
            max-width: 100%;
            padding: 10px;
        }
        .header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
        }
        .btn-primary {
            background-color: #007AFF;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            width: 100%;
        }
        .btn-secondary {
            background-color: #34C759;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .btn-danger-small {
            background-color: #FF3B30;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }
        .btn-primary:active, .btn-secondary:active, .btn-danger-small:active {
            transform: scale(0.98);
        }
        .search-box {
            margin: 15px 0;
        }
        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }
        /* 表格样式 */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .table-wrapper {
            overflow-x: auto;
            max-height: 60vh;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 320px;
        }
        th, td {
            padding: 10px 6px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 11px;
            vertical-align: top;
            word-wrap: break-word;
            word-break: break-all;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:active {
            background-color: #f0f8ff;
        }
        /* 图片单元格 */
        .product-image-cell {
            width: 50px;
            height: 50px;
            text-align: center;
        }
        .product-image-cell img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
            cursor: pointer;
        }
        .product-image-cell .no-image {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: #999;
            border-radius: 3px;
        }
        /* 文本限制样式 */
        .text-limited {
            max-width: 60px;
            max-height: 30px; /* 2行高度 */
            overflow: hidden;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .text-expandable {
            position: relative;
        }
        .text-expandable.expanded .text-limited {
            -webkit-line-clamp: unset;
            max-height: none;
        }
        .expand-btn {
            color: #007AFF;
            cursor: pointer;
            font-size: 9px;
            margin-left: 3px;
            display: inline-block;
        }
        /* 成本显示 */
        .cost-container {
            position: relative;
        }
        .cost-summary {
            font-weight: bold;
        }
        .cost-details {
            display: none;
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        .cost-details.show {
            display: block;
        }
        .toggle-cost {
            color: #007AFF;
            cursor: pointer;
            font-size: 9px;
            margin-left: 3px;
        }
        /* 备注显示 */
        .remark-container {
            position: relative;
        }
        .remark-main {
            max-width: 60px;
            max-height: 28px; /* 2行高度 */
            overflow: hidden;
            word-break: break-all;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .remark-all {
            display: none;
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }
        .remark-all.show {
            display: block;
        }
        .toggle-remark {
            color: #007AFF;
            cursor: pointer;
            font-size: 9px;
            margin-left: 3px;
        }
        /* 操作按钮 */
        .action-container {
            position: relative;
        }
        .action-main {
            display: inline-block;
            background-color: #007AFF;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .action-main.has-history {
            background-color: #FF9500;
            position: relative;
        }
        .action-main.has-history::after {
            content: '!';
            position: absolute;
            top: -4px;
            right: -4px;
            background: #FF3B30;
            color: white;
            border-radius: 50%;
            width: 10px;
            height: 10px;
            font-size: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .action-buttons {
            display: none;
            position: absolute;
            top: 20px;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 100px;
        }
        .action-buttons.show {
            display: block;
        }
        .action-btn {
            display: block;
            width: 100%;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-bottom: 3px;
            text-align: left;
        }
        .action-btn.edit {
            background-color: #FF9500;
            color: white;
        }
        .action-btn.delete {
            background-color: #FF3B30;
            color: white;
        }
        .action-btn.history {
            background-color: #34C759;
            color: white;
        }
        /* 图片放大模态框 */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: hidden;
        }
        .image-modal-content {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
        }
        .image-modal-content img {
            max-width: 90%;
            max-height: 80%;
            object-fit: contain;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* 分页和设置 */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 8px;
        }
        .page-info {
            font-size: 11px;
            color: #666;
            flex: 1;
        }
        .page-size-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            background: white;
        }
        .page-controls {
            display: flex;
            gap: 8px;
        }
        .page-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .page-btn:active:not(:disabled) {
            background-color: #f0f0f0;
        }
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 10px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 95vh;
            overflow-y: auto;
        }
        .close {
            color: #999;
            float: right;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:active {
            color: #333;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 12px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
        }
        .form-group select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 14px;
            padding-right: 30px;
        }
        /* 智能搜索下拉 */
        .autocomplete-container {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover, .autocomplete-item.active {
            background-color: #f0f8ff;
        }
        /* 图片预览 */
        .image-preview {
            width: 100%;
            height: 120px;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            overflow: hidden;
            background: #f8f9fa;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .image-preview .placeholder {
            color: #999;
            text-align: center;
            font-size: 11px;
        }
        /* 备注 */
        .remarks-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin-top: 8px;
        }
        .remark-item {
            display: flex;
            margin-bottom: 8px;
            align-items: center;
            gap: 6px;
        }
        .remark-item input {
            flex: 1;
            margin: 0;
            padding: 8px 10px;
        }
        .btn-danger-tiny {
            background-color: #FF3B30;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            min-width: 50px;
        }
        .btn-success {
            background-color: #34C759;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            min-width: 60px;
        }
        .btn-danger-tiny:active, .btn-success:active {
            transform: scale(0.95);
        }
        /* 历史记录模态框 */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 1100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .history-content {
            background-color: white;
            margin: 15px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 11px;
        }
        .history-item:last-child {
            border-bottom: none;
        }
        .history-time {
            font-weight: 600;
            color: #007AFF;
            margin-bottom: 3px;
        }
        .history-change {
            color: #666;
        }
        /* 清理数据模态框 */
        .clear-data-modal {
            display: none;
            position: fixed;
            z-index: 1200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .clear-data-content {
            background-color: white;
            margin: 15px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .warning-text {
            color: #FF3B30;
            text-align: center;
            margin: 15px 0;
            font-weight: bold;
            font-size: 12px;
        }
        .password-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #FF3B30;
            border-radius: 6px;
            font-size: 13px;
            margin: 12px 0;
            text-align: center;
        }
        /* 批量操作 */
        .batch-controls {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }
        .batch-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }
        .batch-import-export {
            background-color: #34C759;
            color: white;
        }
        .file-input {
            display: none;
        }
        /* 利润计算器 */
        .profit-calculator-modal {
            display: none;
            position: fixed;
            z-index: 1300;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .profit-calculator-content {
            background-color: white;
            margin: 15px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .product-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            background: white;
            margin-bottom: 12px;
        }
        /* 结算信息样式 */
        .result-item {
            background: #f0f8ff;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0 10px 0;
            font-size: 13px;
            border: 1px solid #d0e8ff;
        }
        .result-item strong {
            color: #0056b3;
            font-size: 14px;
            display: block;
            margin-bottom: 8px;
        }
        .result-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .result-label {
            font-weight: 500;
            color: #555;
        }
        .result-value {
            color: #333;
        }
        .profit-line {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #ccc;
            font-size: 14px;
            font-weight: bold;
        }
        .profit-positive {
            color: #28a745;
        }
        .profit-negative {
            color: #dc3545;
        }
        /* 成本输入行 */
        .cost-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .cost-input-group {
            flex: 1;
        }
        .cost-input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .cost-input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 12px;
        }
        /* 订单费用输入行 */
        .order-cost-row {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        .order-cost-group {
            flex: 1;
        }
        .order-cost-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .order-cost-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #333;
            font-size: 12px;
        }
        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                padding: 6px;
            }
            .modal-content {
                margin: 5px auto;
                padding: 12px;
                width: 98%;
            }
            th, td {
                padding: 8px 4px;
                font-size: 10px;
            }
            .pagination-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .page-controls {
                justify-content: center;
            }
            .btn-secondary {
                padding: 6px 10px;
                font-size: 11px;
                margin-right: 5px;
                margin-bottom: 5px;
            }
            .btn-danger-small {
                padding: 5px 8px;
                font-size: 10px;
            }
            .order-cost-row {
                gap: 5px;
            }
            .order-cost-group {
                flex: 1 1 calc(33.333% - 10px);
                min-width: 80px;
            }
            .cost-input-row {
                flex-direction: column;
                gap: 8px;
            }
        }
        /* 加载状态 */
        .loading {
            text-align: center;
            padding: 15px;
            color: #666;
        }
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 30px 15px;
            color: #999;
        }
        .empty-state p {
            margin-top: 8px;
            font-size: 12px;
        }
        /* 底部清理按钮 */
        .footer {
            margin-top: 15px;
            text-align: center;
        }
        .clear-data-btn-footer {
            background-color: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            opacity: 0.6;
        }
        .clear-data-btn-footer:hover {
            opacity: 1;
        }
        .clear-data-btn-footer:active {
            transform: scale(0.98);
        }
        /* 购物车相关样式 */
        .cart-container {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            background-color: #fafafa;
        }
        .cart-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
            text-align: center;
        }
        .cart-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-info {
            flex: 1;
            min-width: 0;
        }
        .cart-item-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 3px;
        }
        .cart-item-sku {
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 11px;
        }
        .cart-item-cost {
            color: #007AFF;
            margin-top: 3px;
            font-size: 11px;
        }
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .quantity-input {
            width: 45px;
            padding: 5px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .remove-btn {
            background-color: #FF3B30;
            color: white;
            border: none;
            padding: 4px 7px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }
        .cart-total {
            text-align: right;
            font-size: 13px;
            font-weight: 500;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            color: #333;
        }
        .cart-empty {
            text-align: center;
            color: #999;
            font-size: 12px;
            padding: 12px 0;
        }
        .cart-item-image {
            width: 30px;
            height: 30px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .cart-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
        }
        .cart-item-image .no-image {
            width: 100%;
            height: 100%;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            color: 999;
            border-radius: 3px;
        }
        /* 导出订单模态框样式 */
        .export-order-modal {
            display: none;
            position: fixed;
            z-index: 1400;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .export-order-content {
            background-color: white;
            margin: 15px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .export-format-options {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 10px;
            margin: 15px 0;
        }
        .export-format-btn {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            background-color: #f0f0f0;
            flex: 1 1 auto;
            min-width: 100px;
            text-align: center;
        }
        .export-format-btn.selected {
            background-color: #007AFF;
            color: white;
            border-color: #007AFF;
        }
        .copy-success-message {
            color: #34C759;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        /* 订单管理样式 */
        .tab-container {
            display: none;
        }
        .order-content {
            display: none;
        }
        .order-content.active {
            display: block;
        }
        .order-summary {
            background: #e8f4ff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .summary-toggle {
            font-weight: bold;
            color: #007AFF;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .summary-details {
            display: none;
        }
        .summary-details.show {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }
        .summary-item {
            display: flex;
            flex-direction: column;
        }
        .summary-label {
            font-weight: 500;
            color: #555;
        }
        .summary-value {
            font-weight: bold;
            color: #333;
        }
        .order-search-box {
            margin: 10px 0;
        }
        .order-search-box input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .order-table th, .order-table td {
            padding: 8px 4px;
            font-size: 10px;
        }
        .order-action-container {
            position: relative;
        }
        .order-action-main {
            display: inline-block;
            background-color: #007AFF;
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }
        .order-action-buttons {
            display: none;
            position: absolute;
            top: 20px;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 100px;
        }
        .order-action-buttons.show {
            display: block;
        }
        .order-action-btn {
            display: block;
            width: 100%;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-bottom: 3px;
            text-align: left;
        }
        .order-action-btn.edit {
            background-color: #FF9500;
            color: white;
        }
        .order-action-btn.delete {
            background-color: #FF3B30;
            color: white;
        }
        .order-action-btn.copy {
            background-color: #34C759;
            color: white;
        }
        .order-cost-summary {
            font-weight: bold;
        }
        .order-cost-details {
            display: none;
            font-size: 9px;
            color: #666;
            margin-top: 2px;
        }
        .order-cost-details.show {
            display: block;
        }
        .toggle-order-cost {
            color: #007AFF;
            cursor: pointer;
            font-size: 8px;
            margin-left: 2px;
        }
        .order-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .order-modal-content {
            background-color: white;
            margin: 10px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 95vh;
            overflow-y: auto;
        }
        .order-form-group {
            margin-bottom: 10px;
        }
        .order-form-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: #333;
            font-size: 11px;
        }
        .order-form-group input, .order-form-group select, .order-form-group textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        .order-autocomplete-container {
            position: relative;
        }
        .order-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 120px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .order-autocomplete-item {
            padding: 8px 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 12px;
        }
        .order-autocomplete-item:last-child {
            border-bottom: none;
        }
        .order-autocomplete-item:hover, .order-autocomplete-item.active {
            background-color: #f0f8ff;
        }
        .order-image-preview {
            width: 100%;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            overflow: hidden;
            background: #f8f9fa;
        }
        .order-image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .order-image-preview .placeholder {
            color: #999;
            text-align: center;
            font-size: 10px;
        }
        .order-filter-modal {
            display: none;
            position: fixed;
            z-index: 1600;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .order-filter-content {
            background-color: white;
            margin: 15px auto;
            padding: 15px;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .filter-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .filter-group {
            flex: 1;
        }
        .filter-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: #333;
            font-size: 11px;
        }
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            background: white;
        }
        .clear-order-data-btn-footer {
            background-color: #FF3B30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            opacity: 0.6;
            margin-top: 10px;
        }
        .clear-order-data-btn-footer:hover {
            opacity: 1;
        }
        .clear-order-data-btn-footer:active {
            transform: scale(0.98);
        }
        /* 底部导航栏 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            border-top: 1px solid #ddd;
            display: flex;
            z-index: 1000;
        }
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            cursor: pointer;
            color: #666;
        }
        .nav-item.active {
            color: #007AFF;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container" style="display: none;">
        <div class="header">
            <h1>商品订单综合管理系统 v10.2.250910.02</h1>
            <button class="btn-primary" onclick="openAddModal()">录入商品</button>
            <button class="btn-secondary" onclick="openBatchImportExport()">批量操作</button>
            <button class="btn-secondary" onclick="openProfitCalculator()">利润计算器</button>
        </div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="搜索商品名称、SKU或备注..." onkeyup="debounceSearch()">
        </div>
        <div class="table-container">
            <div class="table-wrapper">
                <table id="productTable">
                    <thead>
                        <tr>
                            <th>渠道</th>
                            <th>商品名称</th>
                            <th>SKU/规格</th>
                            <th>图片</th>
                            <th>总成本</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        <div class="pagination-controls">
            <div class="page-info" id="pageInfo">第 1 页，共 1 页</div>
            <select class="page-size-select" id="pageSizeSelect" onchange="changePageSize()">
                <option value="20">20条/页</option>
                <option value="50">50条/页</option>
                <option value="100">100条/页</option>
                <option value="all">全部</option>
            </select>
            <div class="page-controls">
                <button class="page-btn" id="prevBtn" onclick="prevPage()" disabled>上一页</button>
                <button class="page-btn" id="nextBtn" onclick="nextPage()" disabled>下一页</button>
            </div>
        </div>
        <div class="footer">
            <button class="clear-data-btn-footer" onclick="openClearDataModal()">清理所有数据</button>
        </div>
		<div style="text-align: center; font-size: 12px; color: #999; margin-top: 10px; padding-bottom: 20px;">
		    kevin鲁大师 版权所有 盗用必究 版本号：v10.2.250910.02
		</div>
    </div>

    <div id="orderContent" class="order-content">
        <div class="container">
            <div class="header">
                <button class="btn-primary" onclick="openAddOrderModal()">录入订单</button>
                <button class="btn-secondary" onclick="openOrderFilterModal()">筛选订单</button>
                <button class="btn-secondary" onclick="exportOrders()">导出订单</button>
                <button class="btn-secondary" onclick="openBatchOrderImport()">批量导入订单</button>
            </div>
            <div class="order-summary" id="orderSummary">
                <div class="summary-toggle" onclick="toggleOrderSummary()">订单汇总 ▼</div>
                <div class="summary-details" id="orderSummaryDetails">
                    </div>
            </div>
            <div class="order-search-box">
                <input type="text" id="orderSearchInput" placeholder="搜索订单号、商品名称或SKU..." onkeyup="debounceOrderSearch()">
            </div>
            <div class="table-container">
                <div class="table-wrapper">
                    <table class="order-table" id="orderTable">
                        <thead>
                            <tr>
                                <th>平台</th>
                                <th>店铺</th>
                                <th>订单号</th>
                                <th>日期</th>
                                <th>商品</th>
                                <th>图片</th>
                                <th>售价</th>
                                <th>成本</th>
                                <th>利润</th>
                                <th>快递</th>
                                <th>收件信息</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="pagination-controls">
                <div class="page-info" id="orderPageInfo">第 1 页，共 1 页</div>
                <select class="page-size-select" id="orderPageSizeSelect" onchange="changeOrderPageSize()">
                    <option value="20">20条/页</option>
                    <option value="50">50条/页</option>
                    <option value="100">100条/页</option>
                    <option value="all">全部</option>
                </select>
                <div class="page-controls">
                    <button class="page-btn" id="orderPrevBtn" onclick="prevOrderPage()" disabled>上一页</button>
                    <button class="page-btn" id="orderNextBtn" onclick="nextOrderPage()" disabled>下一页</button>
                </div>
            </div>
            <div class="footer">
                <button class="clear-order-data-btn-footer" onclick="openClearOrderDataModal()">清理所有订单数据</button>
            </div>
        </div>
    </div>

    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
        <span class="image-modal-close">&times;</span>
        <div class="image-modal-content">
            <img id="modalImage" src="" alt="放大图片">
        </div>
    </div>
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('productModal')">&times;</span>
            <h2 id="modalTitle" style="margin-bottom: 15px; font-size: 16px;">录入商品信息</h2>
            <form id="productForm">
                <input type="hidden" id="editIndex">
                <div class="form-group">
                    <label for="channel">渠道</label>
                    <div class="autocomplete-container">
                        <input type="text" id="channel" placeholder="输入或选择渠道" onfocus="showAllAutocomplete('channel', 'channelDropdown', 'channel')">
                        <div class="autocomplete-dropdown" id="channelDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="productName">商品名称</label>
                    <div class="autocomplete-container">
                        <input type="text" id="productName" placeholder="输入或选择商品名称" onfocus="showAllAutocomplete('productName', 'productNameDropdown', 'productName')">
                        <div class="autocomplete-dropdown" id="productNameDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="sku">SKU/规格</label>
                    <div class="autocomplete-container">
                        <input type="text" id="sku" placeholder="输入或选择SKU/规格" onfocus="showAllAutocomplete('sku', 'skuDropdown', 'sku')">
                        <div class="autocomplete-dropdown" id="skuDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="imageUrl">图片URL</label>
                    <input type="url" id="imageUrl" placeholder="请输入网络图片URL" oninput="previewImage()">
                    <div class="image-preview" id="imagePreview">
                        <div class="placeholder">图片预览区域</div>
                    </div>
                </div>
                <div class="cost-input-row">
                    <div class="cost-input-group">
                        <label for="baseCost">裸成本</label>
                        <input type="number" id="baseCost" step="0.01" min="0" placeholder="裸成本" oninput="calculateTotalCost()">
                    </div>
                    <div class="cost-input-group">
                        <label for="shippingCost">运费</label>
                        <input type="number" id="shippingCost" step="0.01" min="0" placeholder="运费" oninput="calculateTotalCost()">
                    </div>
                    <div class="cost-input-group">
                        <label for="otherCost">其他费用</label>
                        <input type="number" id="otherCost" step="0.01" min="0" placeholder="其他费用" value="" oninput="calculateTotalCost()">
                    </div>
                </div>
                <div class="form-group">
                    <label for="totalCost">总成本</label>
                    <input type="number" id="totalCost" step="0.01" min="0" readonly>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <div class="remarks-container">
                        <div id="remarksList">
                            </div>
                        <button type="button" class="btn-success" onclick="addRemark()" style="margin-top: 8px;">添加备注</button>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 15px;">保存商品</button>
            </form>
        </div>
    </div>
    <div id="batchImportExportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batchImportExportModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">批量操作</h2>
            <button class="btn-secondary" onclick="openBatchImport()" style="width: 100%; margin-bottom: 10px;">批量导入</button>
            <button class="btn-secondary" onclick="exportProducts()" style="width: 100%;">批量导出</button>
        </div>
    </div>
    <div id="batchImportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batchImportModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">批量导入商品</h2>
            <p style="margin-bottom: 12px; color: #666; font-size: 12px;">请选择Excel文件(.xlsx)进行批量导入</p>
            <input type="file" id="importFile" class="file-input" accept=".xlsx" onchange="handleImportFile()">
            <button class="btn-primary" onclick="document.getElementById('importFile').click()" style="margin-bottom: 10px; width: 100%;">选择文件</button>
            <div id="importFileName" style="margin-bottom: 12px; color: #666; font-size: 11px;"></div>
            <button class="btn-secondary" onclick="processImport()" id="importBtn" disabled style="width: 100%;">开始导入</button>
        </div>
    </div>
    <div id="historyModal" class="history-modal">
        <div class="history-content">
            <span class="close" onclick="closeModal('historyModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">历史记录</h2>
            <div id="historyContent">
                </div>
        </div>
    </div>
    <div id="clearDataModal" class="clear-data-modal">
        <div class="clear-data-content">
            <span class="close" onclick="closeModal('clearDataModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">清理所有数据</h2>
            <div class="warning-text">⚠️ 警告：此操作将永久删除所有商品数据！</div>
            <p style="margin-bottom: 12px; color: #666; font-size: 12px;">请输入密码确认操作：</p>
            <input type="password" id="clearPassword" class="password-input" placeholder="请输入密码123456">
            <button class="btn-danger-small" onclick="clearAllData()" style="width: 100%; margin-top: 12px;">确认清理所有数据</button>
        </div>
    </div>
    <div id="profitCalculatorModal" class="profit-calculator-modal">
        <div class="profit-calculator-content">
            <span class="close" onclick="closeProfitCalculator()">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px; text-align: center;">订单结算</h2>
            <div class="form-group">
                <label for="productSelectInput">选择商品</label>
                <div class="autocomplete-container">
                    <input type="text" id="productSelectInput" placeholder="输入商品名称或SKU检索" oninput="searchProductsForProfit(this.value)" onfocus="showAllProductsForProfit()">
                    <div class="autocomplete-dropdown" id="productSelectDropdown" style="display: none;"></div>
                </div>
            </div>
            <div class="cart-container">
                <div class="cart-title">商品列表</div>
                <div class="cart-list" id="cartList">
                    <div class="cart-empty" id="cartEmptyMessage">暂无商品</div>
                </div>
                <div class="cart-total">商品总成本: <span id="cartTotalCost">0.00</span> 元</div>
            </div>
            <div style="text-align: center; margin: 10px 0;">
                <button class="btn-danger-small" onclick="clearCartAndSalePrice()" style="width: 80%;">清除商品和售价</button>
            </div>
            <div class="order-cost-row">
                <div class="order-cost-group">
                    <label for="orderShipping">订单运费</label>
                    <input type="number" id="orderShipping" step="0.01" min="0" placeholder="订单运费" oninput="calculateProfit()">
                </div>
                <div class="order-cost-group">
                    <label for="packingFee">打包费</label>
                    <input type="number" id="packingFee" step="0.01" min="0" placeholder="打包费" oninput="calculateProfit()">
                </div>
                <div class="order-cost-group">
                    <label for="otherFee">其他费用</label>
                    <input type="number" id="otherFee" step="0.01" min="0" placeholder="其他费用" oninput="calculateProfit()">
                </div>
            </div>
            <div class="form-group">
                <label for="salePrice">订单售价</label>
                <input type="number" id="salePrice" step="0.01" min="0" placeholder="请输入订单售价" oninput="calculateProfit()">
            </div>
            <div id="profitResult" style="display: none;">
                <div class="result-item">
                    <strong>订单费用明细</strong>
                    <div class="result-line">
                        <span class="result-label">商品总成本:</span>
                        <span class="result-value">¥<span id="pc_productTotalCost"></span></span>
                    </div>
                    <div class="result-line">
                        <span class="result-label">订单运费:</span>
                        <span class="result-value">¥<span id="pc_orderShippingCost"></span></span>
                    </div>
                    <div class="result-line">
                        <span class="result-label">打包费:</span>
                        <span class="result-value">¥<span id="pc_packingCost"></span></span>
                    </div>
                    <div class="result-line">
                        <span class="result-label">其他费用:</span>
                        <span class="result-value">¥<span id="pc_otherCostResult"></span></span>
                    </div>
                    <hr style="margin: 8px 0; border-color: #e0e0e0;">
                    <div class="result-line">
                        <span class="result-label">订单总成本:</span>
                        <span class="result-value">¥<span id="pc_orderTotalCost"></span></span>
                    </div>
                    <div class="result-line">
                        <span class="result-label">订单售价:</span>
                        <span class="result-value">¥<span id="pc_orderSalePrice"></span></span>
                    </div>
                    <div class="profit-line">
                        <span class="result-label">利润:</span>
                        <span id="pc_profitAmount" class="profit-positive"></span>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn-secondary" onclick="openExportOrderModal()" style="width: 80%;">导出订单</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="exportOrderModal" class="export-order-modal">
        <div class="export-order-content">
            <span class="close" onclick="closeModal('exportOrderModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">导出订单信息</h2>
            <div class="form-group">
                <label for="exportPlatform">平台</label>
                <input type="text" id="exportPlatform" placeholder="请输入平台名称">
            </div>
            <div class="form-group">
                <label for="exportDate">日期</label>
                <input type="date" id="exportDate">
            </div>
            <div class="form-group">
                <label for="exportOrderNumber">订单号</label>
                <input type="text" id="exportOrderNumber" placeholder="请输入订单号">
            </div>
            <div class="form-group">
                <label for="exportRecipientInfo">收件信息</label>
                <input type="text" id="exportRecipientInfo" placeholder="请输入收件人信息 (姓名|地址|电话)">
            </div>
            <div class="form-group">
                <label for="exportExpress">快递</label>
                <input type="text" id="exportExpress" placeholder="请输入快递公司">
            </div>
            <div class="form-group">
                <label for="exportTrackingNumber">快递单号</label>
                <input type="text" id="exportTrackingNumber" placeholder="请输入快递单号">
            </div>
            <div class="export-format-options">
                <button class="export-format-btn" onclick="selectExportFormat('xlsx')">导出为 XLSX</button>
                <button class="export-format-btn" onclick="selectExportFormat('text')">复制文本</button>
                <button class="export-format-btn" onclick="copyForShipping()">发货</button>
            </div>
            <div class="copy-success-message" id="copySuccessMessage">已复制到剪贴板!</div>
            <button class="btn-danger-small" onclick="clearOrderNumberAndRecipient()" style="width: 100%; margin-top: 10px;">清除订单号和收件信息</button>
            <button class="btn-primary" onclick="performExport()" style="width: 100%; margin-top: 10px;">确认导出</button>
        </div>
    </div>

    <div id="orderModal" class="order-modal">
        <div class="order-modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2 id="orderModalTitle" style="margin-bottom: 15px; font-size: 16px;">录入订单信息</h2>
            <form id="orderForm">
                <input type="hidden" id="orderEditIndex">
                <div class="order-form-group">
                    <label for="orderPlatform">平台</label>
                    <div class="order-autocomplete-container">
                        <input type="text" id="orderPlatform" placeholder="输入或选择平台" onfocus="showAllOrderAutocomplete('orderPlatform', 'orderPlatformDropdown')">
                        <div class="order-autocomplete-dropdown" id="orderPlatformDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderShop">店铺</label>
                    <div class="order-autocomplete-container">
                        <input type="text" id="orderShop" placeholder="输入或选择店铺" onfocus="showAllOrderAutocomplete('orderShop', 'orderShopDropdown')">
                        <div class="order-autocomplete-dropdown" id="orderShopDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderNumber">订单号</label>
                    <input type="text" id="orderNumber" placeholder="请输入订单号">
                </div>
                <div class="order-form-group">
                    <label for="orderDate">订单日期</label>
                    <input type="date" id="orderDate">
                </div>
                <div class="order-form-group">
                    <label for="orderProductName">商品名称</label>
                    <div class="order-autocomplete-container">
                        <input type="text" id="orderProductName" placeholder="输入或选择商品名称" onfocus="showAllOrderProductAutocomplete('orderProductName', 'orderProductNameDropdown')" oninput="searchOrderProducts('orderProductName', 'orderProductNameDropdown')">
                        <div class="order-autocomplete-dropdown" id="orderProductNameDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderSku">SKU/规格</label>
                    <div class="order-autocomplete-container">
                        <input type="text" id="orderSku" placeholder="输入或选择SKU/规格" onfocus="showAllOrderProductAutocomplete('orderSku', 'orderSkuDropdown')" oninput="searchOrderProducts('orderSku', 'orderSkuDropdown')">
                        <div class="order-autocomplete-dropdown" id="orderSkuDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderImageUrl">图片URL</label>
                    <input type="url" id="orderImageUrl" placeholder="图片URL" readonly>
                    <div class="order-image-preview" id="orderImagePreview">
                        <div class="placeholder">图片预览区域</div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderQuantity">数量</label>
                    <input type="number" id="orderQuantity" min="1" value="1" oninput="calculateOrderCosts()">
                </div>
                <div class="order-form-group">
                    <label for="orderSalePrice">售价</label>
                    <input type="number" id="orderSalePrice" step="0.01" min="0" placeholder="请输入售价" oninput="calculateOrderCosts()">
                </div>
                <div class="order-form-group">
                    <label for="orderProductCost">商品总成本</label>
                    <input type="number" id="orderProductCost" step="0.01" min="0" readonly>
                </div>
                <div class="order-form-group">
                    <label for="orderShippingFee">运费</label>
                    <input type="number" id="orderShippingFee" step="0.01" min="0" placeholder="请输入运费" value="0" oninput="calculateOrderCosts()">
                </div>
                <div class="order-form-group">
                    <label for="orderPackingFee">打包费</label>
                    <input type="number" id="orderPackingFee" step="0.01" min="0" placeholder="请输入打包费" value="0" oninput="calculateOrderCosts()">
                </div>
                <div class="order-form-group">
                    <label for="orderOtherFee">其他费用</label>
                    <input type="number" id="orderOtherFee" step="0.01" min="0" placeholder="请输入其他费用" value="0" oninput="calculateOrderCosts()">
                </div>
                <div class="order-form-group">
                    <label for="orderTotalCost">订单总成本</label>
                    <input type="number" id="orderTotalCost" step="0.01" min="0" readonly>
                </div>
                <div class="order-form-group">
                    <label for="orderProfit">利润</label>
                    <input type="number" id="orderProfit" step="0.01" readonly>
                </div>
                <div class="order-form-group">
                    <label for="orderProfitMargin">利润率%</label>
                    <input type="number" id="orderProfitMargin" step="0.01" readonly>
                </div>
                <div class="order-form-group">
                    <label for="orderRecipientInfo">收件信息</label>
                    <textarea id="orderRecipientInfo" placeholder="请输入收件人信息 (姓名|地址|电话)"></textarea>
                </div>
                <div class="order-form-group">
                    <label for="orderExpress">快递</label>
                    <div class="order-autocomplete-container">
                        <input type="text" id="orderExpress" placeholder="输入或选择快递" onfocus="showAllOrderAutocomplete('orderExpress', 'orderExpressDropdown')">
                        <div class="order-autocomplete-dropdown" id="orderExpressDropdown" style="display: none;"></div>
                    </div>
                </div>
                <div class="order-form-group">
                    <label for="orderTrackingNumber">快递单号</label>
                    <input type="text" id="orderTrackingNumber" placeholder="请输入快递单号" value="待发货">
                </div>
                <div class="order-form-group">
                    <label for="orderRemarks">备注</label>
                    <textarea id="orderRemarks" placeholder="请输入备注"></textarea>
                </div>
                <button type="submit" class="btn-primary" style="margin-top: 15px;">保存订单</button>
            </form>
        </div>
    </div>

    <div id="orderFilterModal" class="order-filter-modal">
        <div class="order-filter-content">
            <span class="close" onclick="closeOrderFilterModal()">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">筛选订单</h2>
            <form id="orderFilterForm">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterShop">店铺名</label>
                        <input type="text" id="filterShop" placeholder="请输入店铺名">
                    </div>
                    <div class="filter-group">
                        <label for="filterOrderNumber">订单号</label>
                        <input type="text" id="filterOrderNumber" placeholder="请输入订单号">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterProductName">商品名称</label>
                        <input type="text" id="filterProductName" placeholder="请输入商品名称">
                    </div>
                    <div class="filter-group">
                        <label for="filterSku">SKU/规格</label>
                        <input type="text" id="filterSku" placeholder="请输入SKU/规格">
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterTrackingNumber">快递单号</label>
                        <input type="text" id="filterTrackingNumber" placeholder="请输入快递单号">
                    </div>
                    <div class="filter-group">
                        <label for="filterDateRange">时间范围</label>
                        <select id="filterDateRange" onchange="toggleCustomDateRange()">
                            <option value="all">全部订单</option>
                            <option value="today">今天</option>
                            <option value="yesterday">昨天</option>
                            <option value="last7days">最近7天</option>
                            <option value="last30days">最近30天</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row" id="customDateRange" style="display: none;">
                    <div class="filter-group">
                        <label for="startDate">开始日期</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label for="endDate">结束日期</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="applyOrderFilter()" style="width: 100%; margin-top: 15px;">应用筛选</button>
            </form>
        </div>
    </div>

    <div id="clearOrderDataModal" class="clear-data-modal">
        <div class="clear-data-content">
            <span class="close" onclick="closeModal('clearOrderDataModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">清理所有订单数据</h2>
            <div class="warning-text">⚠️ 警告：此操作将永久删除所有订单数据！</div>
            <p style="margin-bottom: 12px; color: #666; font-size: 12px;">请输入密码确认操作：</p>
            <input type="password" id="clearOrderPassword" class="password-input" placeholder="请输入密码123456">
            <button class="btn-danger-small" onclick="clearAllOrderData()" style="width: 100%; margin-top: 12px;">确认清理所有订单数据</button>
        </div>
    </div>

    <div id="batchOrderImportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batchOrderImportModal')">&times;</span>
            <h2 style="margin-bottom: 15px; font-size: 16px;">批量导入订单</h2>
            <p style="margin-bottom: 12px; color: #666; font-size: 12px;">请选择Excel文件(.xlsx)进行批量导入</p>
            <input type="file" id="importOrderFile" class="file-input" accept=".xlsx" onchange="handleImportOrderFile()">
            <button class="btn-primary" onclick="document.getElementById('importOrderFile').click()" style="margin-bottom: 10px; width: 100%;">选择文件</button>
            <div id="importOrderFileName" style="margin-bottom: 12px; color: #666; font-size: 11px;"></div>
            <button class="btn-secondary" onclick="processImportOrder()" id="importOrderBtn" disabled style="width: 100%;">开始导入</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="switchTab('product', this)">商品管理</div>
        <div class="nav-item active" onclick="switchTab('order', this)">订单管理</div>
    </div>

    <script>
        /*
            开发人员说明 (Developer Note):
            关于数据持久化 (Regarding Data Persistence):
            - 当前系统使用浏览器的 localStorage 进行数据存储。这对于中小型数据集来说是方便快捷的。
            - This system currently uses the browser's localStorage for data storage. This is convenient for small to medium-sized datasets.
            局限性 (Limitations):
            1. 存储容量 (Storage Capacity): localStorage 通常有 5-10MB 的大小限制。对于大量的订单数据，这可能会成为瓶颈。
            2. 性能 (Performance): 当数据量变得非常大时，每次加载时读取和解析整个数据集可能会导致页面启动缓慢。
            3. 数据安全 (Data Safety): 数据存储在用户的浏览器中。如果用户清除浏览器缓存或数据，所有信息都将丢失。它不是一个永久可靠的“数据库”。
            改进建议 (Improvement Suggestions):
            - 对于需要处理大量数据并要求更高可靠性的生产环境，建议将数据存储后端化（例如，使用 Node.js + SQL/NoSQL 数据库）或改用更强大的客户端数据库技术，如 IndexedDB。
            - 本次修改未更改存储机制，以保持与原始代码结构的一致性。
        */
        // 全局变量
        let products = [];
        let orders = [];
        let editMode = false;
        let currentEditIndex = -1;
        let currentPage = 1;
        let itemsPerPage = 20;
        let filteredProducts = [];
        let searchTimeout;
        let importFileData = null;
        let importOrderFileData = null;
        let activeDropdown = null;
        let activeIndex = -1;
        let profitProductSearchTimeout = null;
        let defaultOrderShipping = 0;
        let defaultPackingFee = 0;
        let defaultOtherFee = 0;
        let cartItems = [];
        let selectedExportFormat = 'xlsx';
        let currentOrderEditIndex = -1;
        let orderEditMode = false;
        let currentOrderPage = 1;
        let orderItemsPerPage = 20;
        let filteredOrders = [];
        let orderSearchTimeout;
        let orderFilter = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            loadProductsFromStorage();
            loadOrdersFromStorage();
            loadDefaultValues();

            searchProducts(); 
            filterAndSearchOrders();

            document.getElementById('productForm').addEventListener('submit', saveProduct);
            document.getElementById('orderForm').addEventListener('submit', saveOrder);
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.autocomplete-container') && !e.target.closest('.order-autocomplete-container')) {
                    hideAllDropdowns();
                }
            });
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('orderDate').value = today;

            // --- 问题1修复：默认显示订单管理页面 ---
            switchTab('order');
        });

        function loadProductsFromStorage() {
            try {
                const storedData = localStorage.getItem('products');
                if (storedData) {
                    products = JSON.parse(storedData);
                } else {
                    products = [];
                }
            } catch (error)
            {
                console.error('加载数据失败:', error);
                products = [];
            }
        }

        function loadOrdersFromStorage() {
            try {
                const storedData = localStorage.getItem('orders');
                if (storedData) {
                    orders = JSON.parse(storedData);
                } else {
                    orders = [];
                }
            } catch (error) {
                console.error('加载订单数据失败:', error);
                orders = [];
            }
        }

        function loadDefaultValues() {
            try {
                const defaultValues = localStorage.getItem('defaultOrderValues');
                if (defaultValues) {
                    const values = JSON.parse(defaultValues);
                    defaultOrderShipping = values.shipping || 0;
                    defaultPackingFee = values.packing || 0;
                    defaultOtherFee = values.other || 0;
                }
            } catch (error) {
                console.error('加载默认值失败:', error);
            }
        }

        function saveDefaultValues() {
            try {
                const defaultValues = {
                    shipping: defaultOrderShipping,
                    packing: defaultPackingFee,
                    other: defaultOtherFee
                };
                localStorage.setItem('defaultOrderValues', JSON.stringify(defaultValues));
            } catch (error) {
                console.error('保存默认值失败:', error);
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('products', JSON.stringify(products));
            } catch (error) {
                console.error('保存数据失败:', error);
                alert('保存数据失败，请检查存储空间');
            }
        }

        function saveOrdersToLocalStorage() {
            try {
                localStorage.setItem('orders', JSON.stringify(orders));
            } catch (error) {
                console.error('保存订单数据失败:', error);
                alert('保存订单数据失败，请检查存储空间');
            }
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(function() {
                currentPage = 1;
                searchProducts();
            }, 300);
        }

        function openAddModal() {
            editMode = false;
            currentEditIndex = -1;
            document.getElementById('modalTitle').textContent = '录入商品信息';
            document.getElementById('productForm').reset();
            document.getElementById('editIndex').value = '';
            document.getElementById('remarksList').innerHTML = '';
            document.getElementById('imagePreview').innerHTML = '<div class="placeholder">图片预览区域</div>';
            document.getElementById('totalCost').value = '';
            addRemark();
            hideAllDropdowns();
            document.getElementById('productModal').style.display = 'block';
        }

        function openEditModal(index) {
            const actualIndex = filteredProducts[index].originalIndex;
            const product = products[actualIndex];
            editMode = true;
            currentEditIndex = actualIndex;
            document.getElementById('modalTitle').textContent = '编辑商品信息';
            document.getElementById('editIndex').value = actualIndex;
            document.getElementById('channel').value = product.channel || '';
            document.getElementById('productName').value = product.productName || '';
            document.getElementById('sku').value = product.sku || '';
            document.getElementById('imageUrl').value = product.imageUrl || '';
            document.getElementById('baseCost').value = product.baseCost || '';
            document.getElementById('shippingCost').value = product.shippingCost || '';
            document.getElementById('otherCost').value = product.otherCost || 0;
            document.getElementById('totalCost').value = product.totalCost || '';
            const remarksList = document.getElementById('remarksList');
            remarksList.innerHTML = '';
            if (product.remarks && product.remarks.length > 0) {
                product.remarks.forEach((remark) => {
                    addRemark(remark);
                });
            } else {
                addRemark();
            }
            previewImage();
            hideAllDropdowns();
            document.getElementById('productModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            hideAllDropdowns();
            if (modalId === 'exportOrderModal') {
                document.getElementById('copySuccessMessage').style.display = 'none';
                document.querySelectorAll('.export-format-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelector('.export-format-btn').classList.add('selected');
                selectedExportFormat = 'xlsx';
            }
        }

        function previewImage() {
            const imageUrl = document.getElementById('imageUrl').value;
            const preview = document.getElementById('imagePreview');
            if (imageUrl) {
                preview.innerHTML = `<img src="${imageUrl}" alt="预览图片" onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\"placeholder\">图片加载失败</div>'">`;
            } else {
                preview.innerHTML = '<div class="placeholder">图片预览区域</div>';
            }
        }

        function calculateTotalCost() {
            const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            const totalCost = baseCost + shippingCost + otherCost;
            document.getElementById('totalCost').value = totalCost.toFixed(2);
        }

        function addRemark(value = '') {
            const remarksList = document.getElementById('remarksList');
            const remarkDiv = document.createElement('div');
            remarkDiv.className = 'remark-item';
            remarkDiv.innerHTML = `
                <input type="text" placeholder="输入备注内容" value="${value}">
                <button type="button" class="btn-danger-tiny" onclick="removeRemark(this)">删除</button>
            `;
            remarksList.appendChild(remarkDiv);
        }

        function removeRemark(button) {
            if (document.querySelectorAll('.remark-item').length > 1) {
                button.parentElement.remove();
            } else {
                alert('至少需要保留一个备注项');
            }
        }

        function getRemarks() {
            const remarkInputs = document.querySelectorAll('.remark-item input');
            return Array.from(remarkInputs)
                .map(input => input.value.trim())
                .filter(value => value !== '');
        }

        function saveProduct(e) {
            e.preventDefault();
            const index = parseInt(document.getElementById('editIndex').value);
            const channel = document.getElementById('channel').value.trim();
            const productName = document.getElementById('productName').value.trim();
            const sku = document.getElementById('sku').value.trim();
            const imageUrl = document.getElementById('imageUrl').value.trim();
            const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
            const shippingCost = parseFloat(document.getElementById('shippingCost').value) || 0;
            const otherCost = parseFloat(document.getElementById('otherCost').value) || 0;
            const totalCost = parseFloat(document.getElementById('totalCost').value) || 0;
            const remarks = getRemarks();
            if (!productName || !sku) {
                alert('请填写商品名称和SKU/规格！');
                return;
            }
            const product = {
                channel,
                productName,
                sku,
                imageUrl,
                baseCost,
                shippingCost,
                otherCost,
                totalCost,
                remarks,
                createdAt: editMode ? products[index].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            if (editMode) {
                // --- 问题2修复：添加历史记录逻辑 ---
                const oldProduct = products[index];
                const history = oldProduct.history || [];
                if (oldProduct.baseCost !== baseCost) {
                    history.push({ time: new Date().toISOString(), field: '裸成本', oldValue: oldProduct.baseCost, newValue: baseCost });
                }
                if (oldProduct.shippingCost !== shippingCost) {
                    history.push({ time: new Date().toISOString(), field: '运费', oldValue: oldProduct.shippingCost, newValue: shippingCost });
                }
                if (oldProduct.otherCost !== otherCost) {
                    history.push({ time: new Date().toISOString(), field: '其他费用', oldValue: oldProduct.otherCost, newValue: otherCost });
                }
                product.history = history;
                products[index] = product;
            } else {
                product.history = [];
                products.push(product);
            }
            saveToLocalStorage();
            searchProducts(); // 使用searchProducts来重新渲染，因为它会处理过滤
            closeModal('productModal');
            alert(editMode ? '商品信息更新成功！' : '商品信息录入成功！');
        }

        function deleteProduct(index) {
            const actualIndex = filteredProducts[index].originalIndex;
            if (confirm('确定要删除这个商品吗？')) {
                products.splice(actualIndex, 1);
                saveToLocalStorage();
                searchProducts();
            }
        }

        function showHistory(index) {
            const actualIndex = filteredProducts[index].originalIndex;
            const product = products[actualIndex];
            const history = product.history || [];
            const historyContent = document.getElementById('historyContent');
            if (history.length === 0) {
                historyContent.innerHTML = '<p style="text-align: center; color: #666; padding: 15px;">暂无历史记录</p>';
            } else {
                let html = '';
                history.slice().reverse().forEach(record => { // reverse to show latest first
                    const time = new Date(record.time).toLocaleString('zh-CN');
                    html += `
                        <div class="history-item">
                            <div class="history-time">${time}</div>
                            <div class="history-change">${record.field}从 ${record.oldValue} 修改为 ${record.newValue}</div>
                        </div>
                    `;
                });
                historyContent.innerHTML = html;
            }
            document.getElementById('historyModal').style.display = 'block';
        }

        function searchProducts() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredProducts = products
                    .map((product, index) => ({ ...product, originalIndex: index }))
                    .filter(product =>
                        product.productName.toLowerCase().includes(searchTerm) ||
                        product.sku.toLowerCase().includes(searchTerm) ||
                        (product.remarks && product.remarks.some(remark => remark.toLowerCase().includes(searchTerm))) ||
                        (product.channel && product.channel.toLowerCase().includes(searchTerm))
                    );
            } else {
                filteredProducts = products.map((product, index) => ({ ...product, originalIndex: index }));
            }
            renderProductTable();
        }

        function renderProductTable() {
            let pageProducts;
            let totalPages;
            if (itemsPerPage === 'all') {
                pageProducts = filteredProducts;
                totalPages = 1;
            } else {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                pageProducts = filteredProducts.slice(startIndex, endIndex);
                totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            }
            const tableBody = document.getElementById('productTableBody');
            if (pageProducts.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;"><div class="empty-state"><div>📦</div><p>暂无商品信息</p></div></td></tr>`;
            } else {
                let html = '';
                pageProducts.forEach((product, index) => {
                    const displayIndex = itemsPerPage === 'all' ? index : (currentPage - 1) * itemsPerPage + index;
                    const hasHistory = product.history && product.history.length > 0;
                    html += `
                        <tr>
                            <td><div class="text-expandable" id="channel-${displayIndex}"><div class="text-limited">${product.channel || ''}</div>${getTextExpandButton('channel', displayIndex, product.channel || '')}</div></td>
                            <td><div class="text-expandable" id="name-${displayIndex}"><div class="text-limited">${product.productName || ''}</div>${getTextExpandButton('name', displayIndex, product.productName || '')}</div></td>
                            <td><div class="text-expandable" id="sku-${displayIndex}"><div class="text-limited">${product.sku || ''}</div>${getTextExpandButton('sku', displayIndex, product.sku || '')}</div></td>
                            <td class="product-image-cell">${product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.productName}" onclick="showImageModal('${product.imageUrl}')" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'>无图片</div>'">` : '<div class="no-image">无图片</div>'}</td>
                            <td><div class="cost-container"><div class="cost-summary">¥${(product.totalCost || 0).toFixed(2)}</div><div class="cost-details" id="cost-details-${displayIndex}">裸成本: ¥${(product.baseCost || 0).toFixed(2)}<br>运费: ¥${(product.shippingCost || 0).toFixed(2)}<br>其他: ¥${(product.otherCost || 0).toFixed(2)}</div><span class="toggle-cost" onclick="toggleCostDetails(${displayIndex})">详情</span></div></td>
                            <td><div class="remark-container"><div class="remark-main" id="remark-main-${displayIndex}">${(product.remarks && product.remarks[0]) || '无备注'}</div><div class="remark-all" id="remark-all-${displayIndex}">${product.remarks ? product.remarks.map(remark => `<div>${remark}</div>`).join('') : '无备注'}</div>${getRemarkExpandButton(displayIndex, product.remarks)}</div></td>
                            <td><div class="action-container"><div class="action-main ${hasHistory ? 'has-history' : ''}" onclick="toggleActionButtons(${displayIndex})">操作</div><div class="action-buttons" id="action-buttons-${displayIndex}"><button class="action-btn edit" onclick="openEditModal(${displayIndex})">编辑</button><button class="action-btn delete" onclick="deleteProduct(${displayIndex})">删除</button>${hasHistory ? `<button class="action-btn history" onclick="showHistory(${displayIndex})">历史</button>` : ''}</div></div></td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
            }
            if (itemsPerPage === 'all') {
                document.getElementById('pageInfo').textContent = `共 ${filteredProducts.length} 条记录`;
            } else {
                document.getElementById('pageInfo').textContent = `第 ${currentPage} 页，共 ${totalPages} 页，共 ${filteredProducts.length} 条记录`;
            }
            document.getElementById('prevBtn').disabled = currentPage <= 1 || itemsPerPage === 'all';
            document.getElementById('nextBtn').disabled = currentPage >= totalPages || itemsPerPage === 'all';
        }

        function getTextExpandButton(type, index, text) {
            return (text && text.length > 12) ? `<span class="expand-btn" onclick="toggleExpand('${type}-${index}')">展开</span>` : '';
        }

        function getRemarkExpandButton(index, remarks) {
            if (remarks && remarks.length > 1) {
                if (remarks.join('').length > 12) {
                    return `<span class="toggle-remark" onclick="toggleRemarkDetails(${index})">更多</span>`;
                }
            }
            return '';
        }

        function toggleExpand(elementId) {
            const element = document.getElementById(elementId);
            const expandBtn = element.querySelector('.expand-btn');
            element.classList.toggle('expanded');
            if (expandBtn) {
                expandBtn.textContent = element.classList.contains('expanded') ? '收起' : '展开';
            }
        }

        function toggleCostDetails(index) {
            const costDetails = document.getElementById(`cost-details-${index}`);
            const toggleBtn = event.target;
            costDetails.classList.toggle('show');
            toggleBtn.textContent = costDetails.classList.contains('show') ? '收起' : '详情';
        }

        function toggleRemarkDetails(index) {
            const remarkAll = document.getElementById(`remark-all-${index}`);
            const toggleBtn = event.target;
            remarkAll.classList.toggle('show');
            toggleBtn.textContent = remarkAll.classList.contains('show') ? '收起' : '更多';
        }

        function toggleActionButtons(index) {
            document.querySelectorAll('.action-buttons.show').forEach(btn => {
                if (btn.id !== `action-buttons-${index}`) {
                    btn.classList.remove('show');
                }
            });
            document.getElementById(`action-buttons-${index}`).classList.toggle('show');
        }

        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('imageModal').style.display = 'block';
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderProductTable();
            }
        }

        function nextPage() {
            if (itemsPerPage !== 'all') {
                const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProductTable();
                }
            }
        }

        function changePageSize() {
            const select = document.getElementById('pageSizeSelect');
            itemsPerPage = (select.value === 'all') ? 'all' : parseInt(select.value);
            currentPage = 1;
            renderProductTable();
        }

        function exportProducts() {
            if (products.length === 0) {
                alert('没有数据可以导出');
                return;
            }
            try {
                const exportData = products.map(product => {
                    const remarkData = {};
                    if (product.remarks) {
                        product.remarks.forEach((remark, index) => {
                            remarkData[`备注${index + 1}`] = remark;
                        });
                    }
                    const historyData = {};
                    if (product.history) {
                        product.history.forEach((record, index) => {
                            const time = new Date(record.time).toLocaleString('zh-CN');
                            historyData[`历史记录${index + 1}`] = `${time}|${record.field}|${record.oldValue}|${record.newValue}`;
                        });
                    }
                    return {
                        '渠道': product.channel || '', '商品名称': product.productName || '', 'SKU/规格': product.sku || '', '图片URL': product.imageUrl || '', '裸成本': product.baseCost || 0, '运费': product.shippingCost || 0, '其他费用': product.otherCost || 0, '总成本': product.totalCost || 0, '创建时间': product.createdAt ? new Date(product.createdAt).toLocaleString('zh-CN') : '', '更新时间': product.updatedAt ? new Date(product.updatedAt).toLocaleString('zh-CN') : '', ...remarkData, ...historyData
                    };
                });
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '商品信息');
                const fileName = `商品信息_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`;
                XLSX.writeFile(wb, fileName);
                alert('导出成功！');
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请重试');
            }
        }

        function openBatchImportExport() {
            document.getElementById('batchImportExportModal').style.display = 'block';
        }

        function openBatchImport() {
            closeModal('batchImportExportModal');
            document.getElementById('importFile').value = '';
            document.getElementById('importFileName').textContent = '';
            document.getElementById('importBtn').disabled = true;
            importFileData = null;
            document.getElementById('batchImportModal').style.display = 'block';
        }

        function handleImportFile() {
            const fileInput = document.getElementById('importFile');
            const fileNameDiv = document.getElementById('importFileName');
            const importBtn = document.getElementById('importBtn');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDiv.textContent = `已选择文件: ${file.name}`;
                importBtn.disabled = false;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        importFileData = XLSX.utils.sheet_to_json(worksheet);
                    } catch (error) {
                        console.error('读取文件失败:', error);
                        alert('读取文件失败，请确保是有效的Excel文件');
                        importBtn.disabled = true;
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                fileNameDiv.textContent = '';
                importBtn.disabled = true;
                importFileData = null;
            }
        }

        function processImport() {
            if (!importFileData || importFileData.length === 0) {
                alert('请选择有效的Excel文件');
                return;
            }
            try {
                let importedCount = 0;
                let errorCount = 0;
                importFileData.forEach(row => {
                    try {
                        const remarks = Object.keys(row).filter(key => key.startsWith('备注') && row[key]).map(key => row[key]);
                        const history = Object.keys(row).filter(key => key.startsWith('历史记录') && row[key]).map(key => {
                            const parts = row[key].split('|');
                            return (parts.length === 4) ? { time: new Date(parts[0]).toISOString(), field: parts[1], oldValue: parseFloat(parts[2]) || parts[2], newValue: parseFloat(parts[3]) || parts[3] } : null;
                        }).filter(Boolean);
                        
                        const product = {
                            channel: row['渠道'] || '', productName: row['商品名称'] || '', sku: row['SKU/规格'] || '', imageUrl: row['图片URL'] || '', baseCost: parseFloat(row['裸成本']) || 0, shippingCost: parseFloat(row['运费']) || 0, otherCost: parseFloat(row['其他费用']) || 0, totalCost: parseFloat(row['总成本']) || 0, remarks: remarks, history: history, createdAt: row['创建时间'] ? new Date(row['创建时间']).toISOString() : new Date().toISOString(), updatedAt: row['更新时间'] ? new Date(row['更新时间']).toISOString() : new Date().toISOString()
                        };

                        if (product.totalCost === 0) {
                            product.totalCost = product.baseCost + product.shippingCost + product.otherCost;
                        }

                        if (product.productName && product.sku) {
                            products.push(product);
                            importedCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (e) { errorCount++; }
                });

                if (importedCount > 0) {
                    saveToLocalStorage();
                    searchProducts();
                    alert(`导入完成！成功导入 ${importedCount} 条记录${errorCount > 0 ? `，${errorCount} 条记录有错误` : ''}`);
                    closeModal('batchImportModal');
                } else {
                    alert('没有有效的数据可以导入');
                }
            } catch (error) {
                alert('导入失败，请检查文件格式是否正确');
            }
        }

        function openClearDataModal() {
            document.getElementById('clearPassword').value = '';
            document.getElementById('clearDataModal').style.display = 'block';
        }

        function clearAllData() {
            if (document.getElementById('clearPassword').value === '123456') {
                if (confirm('再次确认：确定要删除所有商品数据吗？此操作不可恢复！')) {
                    products = [];
                    saveToLocalStorage();
                    searchProducts();
                    closeModal('clearDataModal');
                    alert('所有数据已清理完成！');
                }
            } else {
                alert('密码错误！');
            }
        }

        function openProfitCalculator() {
            clearProfitCalculator();
            document.getElementById('orderShipping').value = defaultOrderShipping;
            document.getElementById('packingFee').value = defaultPackingFee;
            document.getElementById('otherFee').value = defaultOtherFee;
            document.getElementById('profitCalculatorModal').style.display = 'block';
        }

        function clearProfitCalculator() {
            cartItems = [];
            updateCartDisplay();
            document.getElementById('productSelectInput').value = '';
            hideDropdown('productSelectDropdown');
            document.getElementById('salePrice').value = '';
            document.getElementById('orderShipping').value = '';
            document.getElementById('packingFee').value = '';
            document.getElementById('otherFee').value = '';
            document.getElementById('profitResult').style.display = 'none';
        }
        
        function closeProfitCalculator() {
             clearProfitCalculator();
             document.getElementById('profitCalculatorModal').style.display = 'none';
             hideAllDropdowns();
        }

        function showAllProductsForProfit() {
            const dropdown = document.getElementById('productSelectDropdown');
            if (products.length > 0) {
                dropdown.innerHTML = products.slice(0, 50).map((product, index) => 
                    `<div class="autocomplete-item" onclick="addToCart(${index})">${product.productName} - ${product.sku}</div>`
                ).join('');
                dropdown.style.display = 'block';
                activeDropdown = 'productSelectDropdown';
                activeIndex = -1;
            }
        }

        function searchProductsForProfit(searchTerm) {
            clearTimeout(profitProductSearchTimeout);
            profitProductSearchTimeout = setTimeout(() => {
                const dropdown = document.getElementById('productSelectDropdown');
                if (searchTerm.trim().length > 0) {
                    const lowerSearchTerm = searchTerm.toLowerCase();
                    const filtered = products.filter(p => p.productName.toLowerCase().includes(lowerSearchTerm) || p.sku.toLowerCase().includes(lowerSearchTerm));
                    if (filtered.length > 0) {
                        dropdown.innerHTML = filtered.slice(0, 20).map(product => 
                            `<div class="autocomplete-item" onclick="addToCart(${products.indexOf(product)})">${product.productName} - ${product.sku}</div>`
                        ).join('');
                        dropdown.style.display = 'block';
                        activeDropdown = 'productSelectDropdown';
                        activeIndex = -1;
                    } else {
                        dropdown.innerHTML = '<div class="autocomplete-item" style="color: #999;">未找到匹配的商品</div>';
                        dropdown.style.display = 'block';
                    }
                } else {
                    showAllProductsForProfit();
                }
            }, 300);
        }

        function addToCart(index) {
            const product = products[index];
            if (!product) return;
            const existingItem = cartItems.find(item => item.index === index);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cartItems.push({ index: index, quantity: 1 });
            }
            updateCartDisplay();
            document.getElementById('productSelectInput').value = '';
            hideDropdown('productSelectDropdown');
            calculateProfit();
        }

        function updateCartDisplay() {
            const cartList = document.getElementById('cartList');
            const cartTotalCostElement = document.getElementById('cartTotalCost');
            if (cartItems.length === 0) {
                cartList.innerHTML = '<div class="cart-empty" id="cartEmptyMessage">暂无商品</div>';
                cartTotalCostElement.textContent = '0.00';
                return;
            }
            let totalCartCost = 0;
            cartList.innerHTML = cartItems.map((item, cartIndex) => {
                const product = products[item.index];
                if (!product) return '';
                totalCartCost += (product.totalCost || 0) * item.quantity;
                const imageHtml = product.imageUrl ? `<img src="${product.imageUrl}" alt="${product.productName}" onerror="this.style.display='none'">` : '<div class="no-image">无图</div>';
                return `
                    <div class="cart-item">
                        <div class="cart-item-image">${imageHtml}</div>
                        <div class="cart-item-info">
                            <div class="cart-item-name" title="${product.productName}">${product.productName}</div>
                            <div class="cart-item-sku" title="${product.sku}">${product.sku}</div>
                            <div class="cart-item-cost">单价: ¥${(product.totalCost || 0).toFixed(2)}</div>
                        </div>
                        <div class="cart-item-controls">
                            <input type="number" min="1" class="quantity-input" value="${item.quantity}" onchange="updateCartItemQuantity(${cartIndex}, this.value)">
                            <button class="remove-btn" onclick="removeFromCart(${cartIndex})">删除</button>
                        </div>
                    </div>`;
            }).join('');
            cartTotalCostElement.textContent = totalCartCost.toFixed(2);
        }

        function updateCartItemQuantity(cartIndex, newQuantity) {
            const quantity = parseInt(newQuantity);
            if (!isNaN(quantity) && quantity >= 1) {
                cartItems[cartIndex].quantity = quantity;
            } else {
                alert('请输入有效的数量！');
            }
            updateCartDisplay();
            calculateProfit();
        }

        function removeFromCart(cartIndex) {
            cartItems.splice(cartIndex, 1);
            updateCartDisplay();
            calculateProfit();
        }

        function calculateProfit() {
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const orderShipping = parseFloat(document.getElementById('orderShipping').value) || 0;
            const packingFee = parseFloat(document.getElementById('packingFee').value) || 0;
            const otherFee = parseFloat(document.getElementById('otherFee').value) || 0;
            
            defaultOrderShipping = orderShipping;
            defaultPackingFee = packingFee;
            defaultOtherFee = otherFee;
            saveDefaultValues();
            
            if (cartItems.length > 0 && salePrice > 0) {
                const totalProductCost = cartItems.reduce((sum, item) => sum + (products[item.index].totalCost || 0) * item.quantity, 0);
                const orderTotalCost = totalProductCost + orderShipping + packingFee + otherFee;
                const profit = salePrice - orderTotalCost;
                
                document.getElementById('pc_productTotalCost').textContent = totalProductCost.toFixed(2);
                document.getElementById('pc_orderShippingCost').textContent = orderShipping.toFixed(2);
                document.getElementById('pc_packingCost').textContent = packingFee.toFixed(2);
                document.getElementById('pc_otherCostResult').textContent = otherFee.toFixed(2);
                document.getElementById('pc_orderTotalCost').textContent = orderTotalCost.toFixed(2);
                document.getElementById('pc_orderSalePrice').textContent = salePrice.toFixed(2);
                const profitElement = document.getElementById('pc_profitAmount');
                profitElement.textContent = profit.toFixed(2);
                profitElement.className = profit >= 0 ? 'profit-positive' : 'profit-negative';
                document.getElementById('profitResult').style.display = 'block';
            } else {
                document.getElementById('profitResult').style.display = 'none';
            }
        }

        function clearCartAndSalePrice() {
            cartItems = [];
            updateCartDisplay();
            document.getElementById('salePrice').value = '';
            calculateProfit();
        }

        function openExportOrderModal() {
            const now = new Date();
            const defaultDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            document.getElementById('exportDate').value = defaultDate;
            document.getElementById('exportPlatform').value = localStorage.getItem('lastPlatform') || '';
            document.getElementById('exportExpress').value = localStorage.getItem('lastExpress') || '';
            document.getElementById('exportOrderModal').style.display = 'block';
        }

        function selectExportFormat(format) {
            selectedExportFormat = format;
            document.querySelectorAll('.export-format-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('copySuccessMessage').style.display = 'none';
        }

        function clearOrderNumberAndRecipient() {
            document.getElementById('exportOrderNumber').value = '';
            document.getElementById('exportRecipientInfo').value = '';
        }

        async function performExport() {
            const platform = document.getElementById('exportPlatform').value.trim();
            const dateInput = document.getElementById('exportDate').value;
            const orderNumber = document.getElementById('exportOrderNumber').value.trim();
            const recipientInfo = document.getElementById('exportRecipientInfo').value.trim();
            const express = document.getElementById('exportExpress').value.trim();
            const trackingNumber = document.getElementById('exportTrackingNumber').value.trim();

            localStorage.setItem('lastPlatform', platform);
            localStorage.setItem('lastExpress', express);

            if (!platform || !dateInput || !orderNumber || !recipientInfo) {
                alert('请填写所有必填的订单信息！');
                return;
            }

            const cartDetailsString = cartItems.map(item => {
                const p = products[item.index];
                return p ? `${p.productName}(${p.sku}) x ${item.quantity} = ${(p.totalCost * item.quantity).toFixed(2)}` : '';
            }).join('\n');

            const exportData = {
                platform, 
                formattedDate: new Date(dateInput).toLocaleDateString('zh-CN'), 
                orderNumber, 
                recipientInfo, 
                express, 
                trackingNumber, 
                cartDetailsString,
                productTotalCost: document.getElementById('pc_productTotalCost').textContent,
                orderShippingCost: document.getElementById('pc_orderShippingCost').textContent,
                packingCost: document.getElementById('pc_packingCost').textContent,
                otherCostResult: document.getElementById('pc_otherCostResult').textContent,
                orderTotalCost: document.getElementById('pc_orderTotalCost').textContent,
                orderSalePrice: document.getElementById('pc_orderSalePrice').textContent,
                profitAmount: document.getElementById('pc_profitAmount').textContent
            };

            if (selectedExportFormat === 'xlsx') {
                try {
                    const ws = XLSX.utils.aoa_to_sheet([
                        ['平台', '日期', '订单号', '收件信息', '快递', '快递单号', '商品详情', '商品总成本', '订单运费', '打包费', '其他费用', '订单总成本', '订单售价', '利润'],
                        [exportData.platform, exportData.formattedDate, exportData.orderNumber, exportData.recipientInfo, exportData.express, exportData.trackingNumber, exportData.cartDetailsString, exportData.productTotalCost, exportData.orderShippingCost, exportData.packingCost, exportData.otherCostResult, exportData.orderTotalCost, exportData.orderSalePrice, exportData.profitAmount]
                    ]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, '订单信息');
                    XLSX.writeFile(wb, `订单_${exportData.orderNumber}.xlsx`);
                    alert('订单信息已导出为 XLSX 文件！');
                    closeModal('exportOrderModal');
                } catch (e) { alert('导出 XLSX 文件失败，请重试'); }
            } else {
                const textToCopy = `平台: ${exportData.platform}\n日期: ${exportData.formattedDate}\n订单号: ${exportData.orderNumber}\n收件信息: ${exportData.recipientInfo}\n商品详情:\n${exportData.cartDetailsString}\n商品总成本: ${exportData.productTotalCost}\n订单运费: ${exportData.orderShippingCost}\n打包费: ${exportData.packingCost}\n其他费用: ${exportData.otherCostResult}\n订单总成本: ${exportData.orderTotalCost}\n订单售价: ${exportData.orderSalePrice}\n利润: ${exportData.profitAmount}${exportData.express ? `\n快递: ${exportData.express}` : ''}${exportData.trackingNumber ? `\n快递单号: ${exportData.trackingNumber}` : ''}`;
                await copyToClipboard(textToCopy, '订单信息已复制！');
            }
        }

        async function copyForShipping() {
            const recipientInfo = document.getElementById('exportRecipientInfo').value.trim();
            if (!recipientInfo || cartItems.length === 0) {
                alert('请填写收件信息且购物车不能为空！');
                return;
            }
            const productDetailsString = cartItems.map(item => {
                const p = products[item.index];
                return p ? `${p.sku} x ${item.quantity}` : '';
            }).join('\n');
            const textToCopy = `${recipientInfo}\n${productDetailsString}`;
            await copyToClipboard(textToCopy, '发货信息已复制！');
        }

        async function copyToClipboard(text, successMessage) {
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(text);
                } else {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                }
                showCopySuccess(successMessage);
            } catch (err) {
                alert(`复制失败，请手动复制:\n${text}`);
            }
        }
        
        function showCopySuccess(message = '已复制到剪贴板!') {
            const successMsg = document.getElementById('copySuccessMessage');
            successMsg.textContent = message;
            successMsg.style.display = 'block';
            setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
        }

        // --- Autocomplete Functions ---
        function showAllAutocomplete(inputId, dropdownId, fieldName) {
            const dropdown = document.getElementById(dropdownId);
            const values = [...new Set(products.map(p => p[fieldName]).filter(Boolean))];
            if (values.length > 0) {
                dropdown.innerHTML = values.slice(0, 20).map(value => 
                    `<div class="autocomplete-item" onclick="selectAutocompleteValue('${inputId}', '${value.replace(/'/g, "\\'")}')">${value}</div>`
                ).join('');
                dropdown.style.display = 'block';
                activeDropdown = dropdownId;
                activeIndex = -1;
            }
        }

        function setupAutocomplete(inputId, dropdownId, fieldName) {
            const input = document.getElementById(inputId);
            input.addEventListener('input', () => showAutocomplete(inputId, dropdownId, fieldName, input.value.trim()));
            input.addEventListener('focus', () => showAutocomplete(inputId, dropdownId, fieldName, input.value.trim()));
            input.addEventListener('keydown', (e) => handleDropdownNavigation(e, dropdownId));
        }

        function showAutocomplete(inputId, dropdownId, fieldName, searchTerm) {
            if (searchTerm.length === 0) {
                return showAllAutocomplete(inputId, dropdownId, fieldName);
            }
            const dropdown = document.getElementById(dropdownId);
            const values = [...new Set(products.map(p => p[fieldName]).filter(Boolean))];
            const filteredValues = values.filter(v => v.toLowerCase().includes(searchTerm.toLowerCase())).slice(0, 20);
            if (filteredValues.length > 0) {
                dropdown.innerHTML = filteredValues.map(value => 
                    `<div class="autocomplete-item" onclick="selectAutocompleteValue('${inputId}', '${value.replace(/'/g, "\\'")}')">${value}</div>`
                ).join('');
                dropdown.style.display = 'block';
                activeDropdown = dropdownId;
                activeIndex = -1;
            } else {
                hideDropdown(dropdownId);
            }
        }

        function selectAutocompleteValue(inputId, value) {
            document.getElementById(inputId).value = value;
            hideDropdown(activeDropdown);
            if (['baseCost', 'shippingCost', 'otherCost'].includes(inputId)) {
                calculateTotalCost();
            }
        }

        function handleDropdownNavigation(e, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown || dropdown.style.display === 'none') return;
            const items = dropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = (activeIndex + 1) % items.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = (activeIndex - 1 + items.length) % items.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (activeIndex >= 0) items[activeIndex].click();
            } else if (e.key === 'Escape') {
                hideDropdown(dropdownId);
            } else { return; }
            items.forEach((item, index) => item.classList.toggle('active', index === activeIndex));
        }

        function hideDropdown(dropdownId) {
            if (dropdownId) document.getElementById(dropdownId).style.display = 'none';
        }
        
        function hideAllDropdowns() {
            document.querySelectorAll('.autocomplete-dropdown, .order-autocomplete-dropdown').forEach(d => d.style.display = 'none');
            activeDropdown = null;
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) event.target.style.display = 'none';
            if (event.target.id === 'imageModal') closeImageModal();
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal, .image-modal, .history-modal, .clear-data-modal, .profit-calculator-modal, .export-order-modal, .order-modal, .order-filter-modal').forEach(modal => {
                    if(modal.style.display === 'block') {
                        closeModal(modal.id);
                        if (modal.id === 'profitCalculatorModal') closeProfitCalculator();
                    }
                });
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.action-container')) {
                document.querySelectorAll('.action-buttons.show').forEach(btn => btn.classList.remove('show'));
            }
            if (!e.target.closest('.order-action-container')) {
                document.querySelectorAll('.order-action-buttons.show').forEach(btn => btn.classList.remove('show'));
            }
        });

        // --- 订单管理功能 ---
        function switchTab(tabName, element) {
            document.querySelector('.container').style.display = (tabName === 'product') ? 'block' : 'none';
            document.getElementById('orderContent').style.display = (tabName === 'order') ? 'block' : 'none';
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            // 如果是通过点击触发的，element会存在
            if (element) {
                element.classList.add('active');
            } else { // 如果是页面加载时调用的
                 const targetNav = tabName === 'product' ? document.querySelector('.nav-item:nth-child(1)') : document.querySelector('.nav-item:nth-child(2)');
                 targetNav.classList.add('active');
            }
        }

        function openAddOrderModal() {
            orderEditMode = false;
            document.getElementById('orderModalTitle').textContent = '录入订单信息';
            document.getElementById('orderForm').reset();
            document.getElementById('orderEditIndex').value = '';
            document.getElementById('orderShippingFee').value = localStorage.getItem('lastOrderShippingFee') || '0';
            document.getElementById('orderPackingFee').value = localStorage.getItem('lastOrderPackingFee') || '0';
            document.getElementById('orderOtherFee').value = localStorage.getItem('lastOrderOtherFee') || '0';
            document.getElementById('orderExpress').value = localStorage.getItem('lastOrderExpress') || '';
            document.getElementById('orderTrackingNumber').value = '待发货';
            document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('orderImagePreview').innerHTML = '<div class="placeholder">图片预览区域</div>';
            calculateOrderCosts();
            hideAllDropdowns();
            document.getElementById('orderModal').style.display = 'block';
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
            hideAllDropdowns();
        }

        function showAllOrderAutocomplete(inputId, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            let field;
            if (inputId === 'orderPlatform') field = 'platform';
            else if (inputId === 'orderShop') field = 'shop';
            else if (inputId === 'orderExpress') field = 'express';
            else return;

            const values = [...new Set(orders.map(o => o[field]).filter(Boolean))];
            if (values.length > 0) {
                dropdown.innerHTML = values.slice(0, 20).map(value => 
                    `<div class="order-autocomplete-item" onclick="selectOrderAutocompleteValue('${inputId}', '${value.replace(/'/g, "\\'")}')">${value}</div>`
                ).join('');
                dropdown.style.display = 'block';
                activeDropdown = dropdownId;
                activeIndex = -1;
            }
        }

        function showAllOrderProductAutocomplete(inputId, dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (products.length > 0) {
                dropdown.innerHTML = products.slice(0, 50).map((product, index) => {
                    const text = (inputId === 'orderProductName') ? product.productName : product.sku;
                    const type = (inputId === 'orderProductName') ? 'name' : 'sku';
                    return `<div class="order-autocomplete-item" onclick="selectOrderProduct(${index}, '${type}')">${text}</div>`;
                }).join('');
                dropdown.style.display = 'block';
                activeDropdown = dropdownId;
                activeIndex = -1;
            }
        }

        function searchOrderProducts(inputId, dropdownId) {
            const searchTerm = document.getElementById(inputId).value.trim().toLowerCase();
            if (searchTerm.length === 0) {
                 calculateOrderCosts();
                 return showAllOrderProductAutocomplete(inputId, dropdownId);
            }
            
            const dropdown = document.getElementById(dropdownId);
            const searchField = (inputId === 'orderProductName') ? 'productName' : 'sku';
            const displayField = searchField;
            const type = (inputId === 'orderProductName') ? 'name' : 'sku';

            const filtered = products.filter(p => p[searchField] && p[searchField].toLowerCase().includes(searchTerm));
            if (filtered.length > 0) {
                dropdown.innerHTML = filtered.slice(0, 20).map(product => 
                    `<div class="order-autocomplete-item" onclick="selectOrderProduct(${products.indexOf(product)}, '${type}')">${product[displayField]}</div>`
                ).join('');
                dropdown.style.display = 'block';
                activeDropdown = dropdownId;
                activeIndex = -1;
            } else {
                hideDropdown(dropdownId);
            }
        }

        function selectOrderAutocompleteValue(inputId, value) {
            document.getElementById(inputId).value = value;
            hideDropdown(activeDropdown);
        }

        function selectOrderProduct(productIndex, type) {
            const pIndex = parseInt(productIndex, 10);
            if (isNaN(pIndex) || pIndex < 0 || pIndex >= products.length) {
                console.error('Invalid product index:', productIndex);
                return;
            }
            const product = products[pIndex];
            document.getElementById('orderProductName').value = product.productName;
            document.getElementById('orderSku').value = product.sku;
            document.getElementById('orderImageUrl').value = product.imageUrl || '';
            
            const preview = document.getElementById('orderImagePreview');
            preview.innerHTML = product.imageUrl ? `<img src="${product.imageUrl}" alt="预览图片" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>图片加载失败</div>'">` : '<div class="placeholder">图片预览区域</div>';
            
            calculateOrderCosts();
            hideAllDropdowns();
        }

        function calculateOrderCosts() {
            const productName = document.getElementById('orderProductName').value;
            const sku = document.getElementById('orderSku').value;
            const product = products.find(p => p.productName === productName && p.sku === sku);
            const singleProductBaseCost = product ? (product.totalCost || 0) : 0;
            const quantity = parseInt(document.getElementById('orderQuantity').value) || 1;
            const salePrice = parseFloat(document.getElementById('orderSalePrice').value) || 0;
            const shippingFee = parseFloat(document.getElementById('orderShippingFee').value) || 0;
            const packingFee = parseFloat(document.getElementById('orderPackingFee').value) || 0;
            const otherFee = parseFloat(document.getElementById('orderOtherFee').value) || 0;
            const totalProductCost = singleProductBaseCost * quantity;
            const totalOrderCost = totalProductCost + shippingFee + packingFee + otherFee;
            const profit = salePrice - totalOrderCost;
            const profitMargin = salePrice > 0 ? (profit / salePrice) * 100 : 0;
            document.getElementById('orderProductCost').value = totalProductCost.toFixed(2);
            document.getElementById('orderTotalCost').value = totalOrderCost.toFixed(2);
            document.getElementById('orderProfit').value = profit.toFixed(2);
            document.getElementById('orderProfitMargin').value = profitMargin.toFixed(2);
        }

        function saveOrder(e) {
            e.preventDefault();
            calculateOrderCosts();

            const orderData = {
                platform: document.getElementById('orderPlatform').value.trim(),
                shop: document.getElementById('orderShop').value.trim(),
                orderNumber: document.getElementById('orderNumber').value.trim(),
                orderDate: document.getElementById('orderDate').value,
                productName: document.getElementById('orderProductName').value.trim(),
                sku: document.getElementById('orderSku').value.trim(),
                imageUrl: document.getElementById('orderImageUrl').value.trim(),
                quantity: parseInt(document.getElementById('orderQuantity').value) || 1,
                salePrice: parseFloat(document.getElementById('orderSalePrice').value) || 0,
                productCost: parseFloat(document.getElementById('orderProductCost').value) || 0,
                shippingFee: parseFloat(document.getElementById('orderShippingFee').value) || 0,
                packingFee: parseFloat(document.getElementById('orderPackingFee').value) || 0,
                otherFee: parseFloat(document.getElementById('orderOtherFee').value) || 0,
                totalCost: parseFloat(document.getElementById('orderTotalCost').value) || 0,
                profit: parseFloat(document.getElementById('orderProfit').value) || 0,
                profitMargin: parseFloat(document.getElementById('orderProfitMargin').value) || 0,
                recipientInfo: document.getElementById('orderRecipientInfo').value.trim(),
                express: document.getElementById('orderExpress').value.trim(),
                trackingNumber: document.getElementById('orderTrackingNumber').value.trim(),
                remarks: document.getElementById('orderRemarks').value.trim(),
                updatedAt: new Date().toISOString()
            };

            if (!orderData.platform || !orderData.shop || !orderData.orderNumber || !orderData.orderDate || !orderData.productName || !orderData.sku) {
                alert('请填写必填字段！');
                return;
            }

            localStorage.setItem('lastOrderShippingFee', orderData.shippingFee.toString());
            localStorage.setItem('lastOrderPackingFee', orderData.packingFee.toString());
            localStorage.setItem('lastOrderOtherFee', orderData.otherFee.toString());
            localStorage.setItem('lastOrderExpress', orderData.express);
            
            const index = parseInt(document.getElementById('orderEditIndex').value);
            if (orderEditMode && !isNaN(index) && index >= 0 && index < orders.length) {
                orderData.createdAt = orders[index].createdAt;
                orders[index] = orderData;
            } else {
                orderData.createdAt = new Date().toISOString();
                orders.push(orderData);
            }
            
            saveOrdersToLocalStorage();
            filterAndSearchOrders();
            closeOrderModal();
            alert(orderEditMode ? '订单信息更新成功！' : '订单信息录入成功！');
        }

        function renderOrderTable() {
            let pageOrders;
            let totalPages;
            if (orderItemsPerPage === 'all') {
                pageOrders = filteredOrders;
                totalPages = 1;
            } else {
                const startIndex = (currentOrderPage - 1) * orderItemsPerPage;
                pageOrders = filteredOrders.slice(startIndex, startIndex + orderItemsPerPage);
                totalPages = Math.ceil(filteredOrders.length / orderItemsPerPage);
            }

            const tableBody = document.getElementById('orderTableBody');
            if (pageOrders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" style="text-align: center; padding: 30px;"><div class="empty-state"><div>📦</div><p>暂无订单信息</p></div></td></tr>`;
            } else {
                tableBody.innerHTML = pageOrders.map((order, index) => {
                    const displayIndex = orderItemsPerPage === 'all' ? index : (currentOrderPage - 1) * orderItemsPerPage + index;
                    const originalOrderIndex = order.originalIndex;
                    const recipientInfo = order.recipientInfo || '';
                    return `
                        <tr>
                            <td>${order.platform || ''}</td>
                            <td>${order.shop || ''}</td>
                            <td>${order.orderNumber || ''}</td>
                            <td>${order.orderDate ? new Date(order.orderDate).toLocaleDateString('zh-CN', {timeZone: 'UTC'}) : ''}</td>
                            <td><div class="text-expandable" id="order-product-${displayIndex}"><div class="text-limited">${order.productName || ''} (${order.sku || ''}) x ${order.quantity || 1}</div>${((order.productName && order.productName.length > 6) || (order.sku && order.sku.length > 6)) ? `<span class="expand-btn" onclick="toggleExpand('order-product-${displayIndex}')">展开</span>` : ''}</div></td>
                            <td class="product-image-cell">${order.imageUrl ? `<img src="${order.imageUrl}" alt="${order.productName}" onclick="showImageModal('${order.imageUrl}')" onerror="this.parentElement.innerHTML='<div class=\\'no-image\\'>无图片</div>'">` : '<div class="no-image">无图片</div>'}</td>
                            <td>¥${(order.salePrice || 0).toFixed(2)}</td>
                            <td><div class="cost-container"><div class="order-cost-summary">¥${(order.totalCost || 0).toFixed(2)}</div><div class="order-cost-details" id="order-cost-details-${displayIndex}">商品: ¥${(order.productCost || 0).toFixed(2)}<br>运费: ¥${(order.shippingFee || 0).toFixed(2)}<br>打包: ¥${(order.packingFee || 0).toFixed(2)}<br>其他: ¥${(order.otherFee || 0).toFixed(2)}</div><span class="toggle-order-cost" onclick="toggleOrderCostDetails(${displayIndex})">详情</span></div></td>
                            <td><span class="${(order.profit || 0) >= 0 ? 'profit-positive' : 'profit-negative'}">¥${(order.profit || 0).toFixed(2)}</span><div style="font-size: 9px; color: #999;">${(order.profitMargin || 0).toFixed(2)}%</div></td>
                            <td>${order.express || ''}<br/>${order.trackingNumber || ''}</td>
                            <td><div class="text-expandable" id="order-recipient-${displayIndex}"><div class="text-limited">${recipientInfo}</div>${getTextExpandButton('order-recipient', displayIndex, recipientInfo)}</div></td>
                            <td><div class="order-action-container"><div class="order-action-main" onclick="toggleOrderActionButtons(${displayIndex})">操作</div><div class="order-action-buttons" id="order-action-buttons-${displayIndex}"><button class="order-action-btn edit" onclick="openEditOrderModal(${originalOrderIndex})">编辑</button><button class="order-action-btn delete" onclick="deleteOrder(${originalOrderIndex})">删除</button><button class="order-action-btn copy" onclick="copyOrderInfo(${originalOrderIndex})">复制</button></div></div></td>
                        </tr>
                    `;
                }).join('');
            }
            
            if (orderItemsPerPage === 'all') {
                document.getElementById('orderPageInfo').textContent = `共 ${filteredOrders.length} 条记录`;
            } else {
                document.getElementById('orderPageInfo').textContent = `第 ${currentOrderPage} 页，共 ${totalPages} 页，共 ${filteredOrders.length} 条记录`;
            }
            document.getElementById('orderPrevBtn').disabled = currentOrderPage <= 1 || orderItemsPerPage === 'all';
            document.getElementById('orderNextBtn').disabled = currentOrderPage >= totalPages || orderItemsPerPage === 'all';
        }


        function openEditOrderModal(actualIndex) {
            const order = orders[actualIndex];
            if (!order) {
                console.error("Order not found for index:", actualIndex);
                return;
            }
            orderEditMode = true;
            document.getElementById('orderModalTitle').textContent = '编辑订单信息';
            document.getElementById('orderEditIndex').value = actualIndex;

            // --- 问题3修复：从循环赋值改为直接赋值，确保ID正确匹配 ---
            document.getElementById('orderPlatform').value = order.platform || '';
            document.getElementById('orderShop').value = order.shop || '';
            document.getElementById('orderNumber').value = order.orderNumber || '';
            document.getElementById('orderDate').value = order.orderDate || '';
            document.getElementById('orderProductName').value = order.productName || '';
            document.getElementById('orderSku').value = order.sku || '';
            document.getElementById('orderImageUrl').value = order.imageUrl || '';
            document.getElementById('orderQuantity').value = order.quantity || 1;
            document.getElementById('orderSalePrice').value = order.salePrice || 0;
            document.getElementById('orderProductCost').value = order.productCost || 0;
            document.getElementById('orderShippingFee').value = order.shippingFee || 0;
            document.getElementById('orderPackingFee').value = order.packingFee || 0;
            document.getElementById('orderOtherFee').value = order.otherFee || 0;
            document.getElementById('orderTotalCost').value = order.totalCost || 0;
            document.getElementById('orderProfit').value = order.profit || 0;
            document.getElementById('orderProfitMargin').value = order.profitMargin || 0;
            document.getElementById('orderRecipientInfo').value = order.recipientInfo || '';
            document.getElementById('orderExpress').value = order.express || '';
            document.getElementById('orderTrackingNumber').value = order.trackingNumber || '';
            document.getElementById('orderRemarks').value = order.remarks || '';
            
            const preview = document.getElementById('orderImagePreview');
            preview.innerHTML = order.imageUrl ? `<img src="${order.imageUrl}" alt="预览图片" onerror="this.parentElement.innerHTML='<div class=\\'placeholder\\'>图片加载失败</div>'">` : '<div class="placeholder">图片预览区域</div>';
            hideAllDropdowns();
            document.getElementById('orderModal').style.display = 'block';
        }

        function deleteOrder(actualIndex) {
            if (confirm('确定要删除这个订单吗？')) {
                orders.splice(actualIndex, 1);
                saveOrdersToLocalStorage();
                filterAndSearchOrders();
            }
        }

        async function copyOrderInfo(actualIndex) {
            const order = orders[actualIndex];
            const textToCopy = `${order.recipientInfo || ''}\n${order.sku || ''} * ${order.quantity || 1}件`;
            await copyToClipboard(textToCopy, '订单信息已复制到剪贴板！');
        }

        function toggleOrderCostDetails(index) {
            const costDetails = document.getElementById(`order-cost-details-${index}`);
            const toggleBtn = event.target;
            costDetails.classList.toggle('show');
            toggleBtn.textContent = costDetails.classList.contains('show') ? '收起' : '详情';
        }

        function toggleOrderActionButtons(index) {
            document.querySelectorAll('.order-action-buttons.show').forEach(btn => {
                if (btn.id !== `order-action-buttons-${index}`) btn.classList.remove('show');
            });
            document.getElementById(`order-action-buttons-${index}`).classList.toggle('show');
        }

        function debounceOrderSearch() {
            clearTimeout(orderSearchTimeout);
            orderSearchTimeout = setTimeout(() => {
                currentOrderPage = 1;
                filterAndSearchOrders();
            }, 300);
        }

        function changeOrderPageSize() {
            const select = document.getElementById('orderPageSizeSelect');
            orderItemsPerPage = (select.value === 'all') ? 'all' : parseInt(select.value);
            currentOrderPage = 1;
            renderOrderTable();
        }

        function prevOrderPage() {
            if (currentOrderPage > 1) {
                currentOrderPage--;
                renderOrderTable();
            }
        }

        function nextPage() {
            if (orderItemsPerPage !== 'all') {
                const totalPages = Math.ceil(filteredOrders.length / orderItemsPerPage);
                if (currentOrderPage < totalPages) {
                    currentOrderPage++;
                    renderOrderTable();
                }
            }
        }
        
        function openOrderFilterModal() { document.getElementById('orderFilterModal').style.display = 'block'; }
        function closeOrderFilterModal() { document.getElementById('orderFilterModal').style.display = 'none'; }
        
        function toggleCustomDateRange() {
            document.getElementById('customDateRange').style.display = (document.getElementById('filterDateRange').value === 'custom') ? 'flex' : 'none';
        }

        function applyOrderFilter() {
            orderFilter = {
                shop: document.getElementById('filterShop').value.trim().toLowerCase(),
                orderNumber: document.getElementById('filterOrderNumber').value.trim().toLowerCase(),
                productName: document.getElementById('filterProductName').value.trim().toLowerCase(),
                sku: document.getElementById('filterSku').value.trim().toLowerCase(),
                trackingNumber: document.getElementById('filterTrackingNumber').value.trim().toLowerCase(),
                dateRange: document.getElementById('filterDateRange').value,
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
            };
            currentOrderPage = 1;
            filterAndSearchOrders();
            closeOrderFilterModal();
        }

        function filterAndSearchOrders() {
            const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
            let tempOrders = [...orders];

            if (orderFilter.shop) tempOrders = tempOrders.filter(o => o.shop && o.shop.toLowerCase().includes(orderFilter.shop));
            if (orderFilter.orderNumber) tempOrders = tempOrders.filter(o => o.orderNumber && o.orderNumber.toLowerCase().includes(orderFilter.orderNumber));
            if (orderFilter.productName) tempOrders = tempOrders.filter(o => o.productName && o.productName.toLowerCase().includes(orderFilter.productName));
            if (orderFilter.sku) tempOrders = tempOrders.filter(o => o.sku && o.sku.toLowerCase().includes(orderFilter.sku));
            if (orderFilter.trackingNumber) tempOrders = tempOrders.filter(o => o.trackingNumber && o.trackingNumber.toLowerCase().includes(orderFilter.trackingNumber));

            if (orderFilter.dateRange && orderFilter.dateRange !== 'all') {
                const now = new Date();
                now.setHours(0, 0, 0, 0); 
                const today = now.getTime();
                
                if (orderFilter.dateRange === 'today') {
                    tempOrders = tempOrders.filter(o => new Date(o.orderDate).getTime() >= today);
                } else if (orderFilter.dateRange === 'yesterday') {
                    const yesterday = new Date(now);
                    yesterday.setDate(now.getDate() - 1);
                    tempOrders = tempOrders.filter(o => {
                        const orderDate = new Date(o.orderDate);
                        return orderDate.getTime() >= yesterday.getTime() && orderDate.getTime() < today;
                    });
                } else if (orderFilter.dateRange === 'last7days') {
                    const sevenDaysAgo = new Date(now);
                    sevenDaysAgo.setDate(now.getDate() - 6);
                    tempOrders = tempOrders.filter(o => new Date(o.orderDate) >= sevenDaysAgo);
                } else if (orderFilter.dateRange === 'last30days') {
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(now.getDate() - 29);
                    tempOrders = tempOrders.filter(o => new Date(o.orderDate) >= thirtyDaysAgo);
                } else if (orderFilter.dateRange === 'custom' && orderFilter.startDate && orderFilter.endDate) {
                    const start = new Date(orderFilter.startDate);
                    const end = new Date(orderFilter.endDate);
                    end.setHours(23, 59, 59, 999);
                    tempOrders = tempOrders.filter(o => {
                        const orderDate = new Date(o.orderDate);
                        return orderDate >= start && orderDate <= end;
                    });
                }
            }

            if (searchTerm) {
                tempOrders = tempOrders.filter(o => 
                    (o.orderNumber && o.orderNumber.toLowerCase().includes(searchTerm)) ||
                    (o.productName && o.productName.toLowerCase().includes(searchTerm)) ||
                    (o.sku && o.sku.toLowerCase().includes(searchTerm)) ||
                    (o.shop && o.shop.toLowerCase().includes(searchTerm)) ||
                    (o.platform && o.platform.toLowerCase().includes(searchTerm))
                );
            }

            filteredOrders = tempOrders.reverse().map(order => ({...order, originalIndex: orders.indexOf(order)}));
            
            updateOrderSummary();
            renderOrderTable();
        }

        function exportOrders() {
            if (filteredOrders.length === 0) {
                alert('没有数据可以导出');
                return;
            }
            try {
                const exportData = filteredOrders.map(o => ({
                    '平台': o.platform, '店铺': o.shop, '订单号': o.orderNumber, '订单日期': o.orderDate, '商品名称': o.productName, 'SKU/规格': o.sku, '图片URL': o.imageUrl, '数量': o.quantity, '售价': o.salePrice, '商品总成本': o.productCost, '运费': o.shippingFee, '打包费': o.packingFee, '其他费用': o.otherFee, '订单总成本': o.totalCost, '利润': o.profit, '利润率%': o.profitMargin, '收件信息': o.recipientInfo, '快递': o.express, '快递单号': o.trackingNumber, '备注': o.remarks, '创建时间': new Date(o.createdAt).toLocaleString('zh-CN'), '更新时间': new Date(o.updatedAt).toLocaleString('zh-CN')
                }));
                const ws = XLSX.utils.json_to_sheet(exportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, '订单信息');
                XLSX.writeFile(wb, `订单信息_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.xlsx`);
                alert('导出成功！');
            } catch (e) { alert('导出失败，请重试'); }
        }

        function updateOrderSummary() {
            const summaryDetails = document.getElementById('orderSummaryDetails');
            const summaryOrders = filteredOrders;
            
            if (summaryOrders.length === 0) {
                summaryDetails.innerHTML = '<div class="summary-item"><span class="summary-label">暂无数据</span><span class="summary-value"></span></div>';
                return;
            }

            const totals = summaryOrders.reduce((acc, order) => {
                acc.totalSalePrice += order.salePrice || 0;
                acc.totalProductCost += order.productCost || 0;
                acc.totalShippingFee += order.shippingFee || 0;
                acc.totalPackingFee += order.packingFee || 0;
                acc.totalOtherFee += order.otherFee || 0;
                acc.totalCost += order.totalCost || 0;
                acc.totalProfit += order.profit || 0;
                return acc;
            }, { totalSalePrice: 0, totalProductCost: 0, totalShippingFee: 0, totalPackingFee: 0, totalOtherFee: 0, totalCost: 0, totalProfit: 0 });
            
            const profitMargin = totals.totalSalePrice ? (totals.totalProfit / totals.totalSalePrice * 100) : 0;
            
            summaryDetails.innerHTML = `
                <div class="summary-item"><span class="summary-label">售价:</span><span class="summary-value">¥${totals.totalSalePrice.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">商品成本:</span><span class="summary-value">¥${totals.totalProductCost.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">运费:</span><span class="summary-value">¥${totals.totalShippingFee.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">打包费:</span><span class="summary-value">¥${totals.totalPackingFee.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">其他费:</span><span class="summary-value">¥${totals.totalOtherFee.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">总成本:</span><span class="summary-value">¥${totals.totalCost.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">利润:</span><span class="summary-value ${totals.totalProfit >= 0 ? 'profit-positive' : 'profit-negative'}">¥${totals.totalProfit.toFixed(2)}</span></div>
                <div class="summary-item"><span class="summary-label">利润率:</span><span class="summary-value">${profitMargin.toFixed(2)}%</span></div>
            `;
        }


        function toggleOrderSummary() {
            const summaryDetails = document.getElementById('orderSummaryDetails');
            const toggle = document.querySelector('.summary-toggle');
            summaryDetails.classList.toggle('show');
            toggle.innerHTML = summaryDetails.classList.contains('show') ? '订单汇总 ▲' : '订单汇总 ▼';
        }

        function openClearOrderDataModal() {
            document.getElementById('clearOrderPassword').value = '';
            document.getElementById('clearOrderDataModal').style.display = 'block';
        }

        function clearAllOrderData() {
            if (document.getElementById('clearOrderPassword').value === '123456') {
                if (confirm('再次确认：确定要删除所有订单数据吗？此操作不可恢复！')) {
                    orders = [];
                    saveOrdersToLocalStorage();
                    filterAndSearchOrders();
                    closeModal('clearOrderDataModal');
                    alert('所有订单数据已清理完成！');
                }
            } else {
                alert('密码错误！');
            }
        }

        function openBatchOrderImport() {
            document.getElementById('importOrderFile').value = '';
            document.getElementById('importOrderFileName').textContent = '';
            document.getElementById('importOrderBtn').disabled = true;
            importOrderFileData = null;
            document.getElementById('batchOrderImportModal').style.display = 'block';
        }

        function handleImportOrderFile() {
            const fileInput = document.getElementById('importOrderFile');
            const fileNameDiv = document.getElementById('importOrderFileName');
            const importBtn = document.getElementById('importOrderBtn');
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                fileNameDiv.textContent = `已选择文件: ${file.name}`;
                importBtn.disabled = false;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        importOrderFileData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    } catch (e) {
                        alert('读取文件失败，请确保是有效的Excel文件');
                        importBtn.disabled = true;
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                fileNameDiv.textContent = '';
                importBtn.disabled = true;
                importOrderFileData = null;
            }
        }

        function processImportOrder() {
            if (!importOrderFileData || importOrderFileData.length === 0) {
                alert('请选择有效的Excel文件');
                return;
            }
            try {
                let importedCount = 0;
                let errorCount = 0;
                importOrderFileData.forEach(row => {
                    try {
                        const order = {
                            platform: row['平台'] || '', shop: row['店铺'] || '', orderNumber: String(row['订单号'] || ''), orderDate: row['订单日期'] || '', productName: row['商品名称'] || '', sku: row['SKU/规格'] || '', imageUrl: row['图片URL'] || '', quantity: parseInt(row['数量']) || 1, salePrice: parseFloat(row['售价']) || 0, productCost: parseFloat(row['商品总成本']) || 0, shippingFee: parseFloat(row['运费']) || 0, packingFee: parseFloat(row['打包费']) || 0, otherFee: parseFloat(row['其他费用']) || 0, totalCost: parseFloat(row['订单总成本']) || 0, profit: parseFloat(row['利润']) || 0, profitMargin: parseFloat(row['利润率%']) || 0, recipientInfo: row['收件信息'] || '', express: row['快递'] || '', trackingNumber: String(row['快递单号'] || ''), remarks: row['备注'] || '', createdAt: row['创建时间'] ? new Date(row['创建时间']).toISOString() : new Date().toISOString(), updatedAt: row['更新时间'] ? new Date(row['更新时间']).toISOString() : new Date().toISOString()
                        };
                        if (order.platform && order.shop && order.orderNumber && order.orderDate && order.productName && order.sku) {
                            orders.push(order);
                            importedCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (e) { errorCount++; }
                });
                if (importedCount > 0) {
                    saveOrdersToLocalStorage();
                    filterAndSearchOrders();
                    alert(`导入完成！成功导入 ${importedCount} 条记录${errorCount > 0 ? `，${errorCount} 条记录有错误` : ''}`);
                    closeModal('batchOrderImportModal');
                } else {
                    alert('没有有效的数据可以导入');
                }
            } catch (e) {
                alert('导入失败，请检查文件格式是否正确');
            }
        }
    </script>
</body>
</html>